{% extends "layout.html" %}
{% block title %}Standings{% endblock %}

{% block content %}
<section class="page-header">
  <h1 class="h1">Standings</h1>
</section>

<form class="board-controls" method="get" action="{{ url_for('leaderboard') }}">
  <div class="controls-row">
    <div class="control">
      <label for="scope" class="label">Scope</label>
      <select id="scope" name="scope" class="select">
        <option value="season" {{ 'selected' if scope == 'season' else '' }}>Season</option>
        <option value="week"   {{ 'selected' if scope == 'week' else '' }}>Matchday</option>
        <option value="overall" {{ 'selected' if scope == 'overall' else '' }}>Overall</option>
      </select>
    </div>

    <div class="control">
      <label for="season" class="label">Season</label>
      <select id="season" name="season" class="select">
        {% for s in seasons %}
          <option value="{{ s }}" {{ 'selected' if s == season else '' }}>{{ s }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="control" {% if scope != 'week' %}style="display:none"{% endif %}>
      <label for="matchday" class="label">Matchday</label>
      <select id="matchday" name="matchday" class="select">
        {% for md in matchdays or [] %}
          <option value="{{ md }}" {{ 'selected' if md|string == matchday|string else '' }}>{{ md }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="control control--btn">
      <button class="btn btn-primary" type="submit">Update</button>
    </div>
  </div>
</form>

{% set heading %}
  {% if scope == 'overall' %}
    Overall ranking.
  {% elif scope == 'week' and matchday %}
    Matchday {{ matchday }} ranking.
  {% else %}
    Season {{ season }} ranking.
  {% endif %}
{% endset %}

<p class="subtle">{{ heading|trim }}</p>

<div class="table-card">
  <table class="table table-striped">
    <colgroup>
      <col style="width: 80px" />
      <col />
      <col style="width: 120px" />
    </colgroup>
    <thead>
      <tr>
        <th scope="col" class="th num">Rank</th>
        <th scope="col" class="th">Username</th>
        <th scope="col" class="th num">Points</th>
      </tr>
    </thead>
    <tbody>
      {% if users and users|length > 0 %}
        {% for u in users %}
          {% if scope == 'overall' %}
            {% set uname = u.username %}
            {% set pts = u.points %}
          {% else %}
            {# u is a dict: {'username': ..., 'points': ...} #}
            {% set uname = u.username if u.username is defined else u['username'] %}
            {% set pts   = u.points   if u.points   is defined else u['points'] %}
          {% endif %}
          <tr>
            <td class="td num">{{ loop.index }}</td>
            <td class="td">{{ uname }}</td>
            <td class="td num">{{ pts }}</td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td class="td" colspan="3" style="text-align:center; opacity:.8;">No data yet.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<p class="footnote">Times are shown in your local time. Data source: football-data.org (free tier).</p>

<script>
  // Toggle matchday selector based on Scope
  const scope = document.getElementById('scope');
  const mdControl = document.getElementById('matchday')?.closest('.control');
  function toggleMatchday() {
    if (!mdControl) return;
    mdControl.style.display = (scope.value === 'week') ? '' : 'none';
  }
  scope?.addEventListener('change', toggleMatchday);
  toggleMatchday();
</script>
{% endblock %}
