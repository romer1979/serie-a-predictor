{% extends "base.html" %}
{% block title %}Fixtures · Serie A Predictor{% endblock %}
{% block content %}

<section class="panel">
  <div class="panel-head">
    <h1 class="panel-title">Upcoming fixtures</h1>
    <div class="panel-actions">
      <form action="{{ url_for('save_all_predictions') }}" method="post">
        <button class="btn btn-primary">Save all picks</button>
      </form>
      {% if current_user.is_admin %}
      <form action="{{ url_for('admin_refresh') }}" method="post">
        <button class="btn btn-outline">Refresh fixtures</button>
      </form>
      {% endif %}
    </div>
  </div>

  {% if fixtures %}
  <div class="table-wrap">
    <table class="data-table" data-sortable>
      <thead>
        <tr>
          <th class="sm" data-sort>MD</th>
          <th data-sort>Fixture</th>
          <th class="md" data-sort>Date / Time (ET)</th>
          <th class="sm" data-sort>Status</th>
          <th class="sm center" data-sort>Score</th>
          <th class="lg center">Your Pick</th>
          <th class="lg">All Picks (revealed after kickoff)</th>
        </tr>
      </thead>
      <tbody>
        {% for f in fixtures %}
          {% set kickoff_iso = f.match_date.isoformat() %}
          {% set is_open = f.is_open_for_prediction() %}
          <tr>
            <td class="muted sm" data-sort-value="{{ f.matchday or '' }}">{{ f.matchday or '—' }}</td>

            <td>
              <div class="teams">
                <span class="team">{{ f.home_team }}</span>
                <span class="vs">vs</span>
                <span class="team">{{ f.away_team }}</span>
              </div>
            </td>

            <td class="md" data-sort-value="{{ f.match_date.timestamp() }}">
              <div class="when">
                <div class="date">{{ f.match_date.strftime('%a, %b %d') }}</div>
                <div class="time">{{ f.match_date.strftime('%H:%M') }} <span class="tz">ET</span></div>
                <div class="countdown">
                  <span class="badge" data-kickoff-iso="{{ kickoff_iso }}">—</span>
                </div>
              </div>
            </td>

            <td class="sm">
              {% if f.status in ['IN_PLAY','PAUSED'] %}
                <span class="chip live">LIVE</span>
              {% elif f.status == 'FINISHED' %}
                <span class="chip finished">FINISHED</span>
              {% else %}
                <span class="chip scheduled">SCHEDULED</span>
              {% endif %}
            </td>

            <td class="sm center">
              {% if f.home_score is not none and f.away_score is not none %}
                <strong>{{ f.home_score }}–{{ f.away_score }}</strong>
              {% else %}
                <span class="muted">—</span>
              {% endif %}
            </td>

            <td class="lg center">
              <div class="pick-wrap {% if not is_open %}locked{% endif %}">
                <label class="pick">
                  <input type="radio" name="fixture_{{ f.id }}" form="bulkForm" value="1"
                    {% if user_predictions.get(f.id) and user_predictions.get(f.id).selection == '1' %}checked{% endif %}
                    {% if not is_open %}disabled{% endif %}>
                  <span>1</span>
                  <small>{{ f.home_team }}</small>
                </label>
                <label class="pick">
                  <input type="radio" name="fixture_{{ f.id }}" form="bulkForm" value="X"
                    {% if user_predictions.get(f.id) and user_predictions.get(f.id).selection == 'X' %}checked{% endif %}
                    {% if not is_open %}disabled{% endif %}>
                  <span>X</span>
                  <small>Draw</small>
                </label>
                <label class="pick">
                  <input type="radio" name="fixture_{{ f.id }}" form="bulkForm" value="2"
                    {% if user_predictions.get(f.id) and user_predictions.get(f.id).selection == '2' %}checked{% endif %}
                    {% if not is_open %}disabled{% endif %}>
                  <span>2</span>
                  <small>{{ f.away_team }}</small>
                </label>
              </div>
            </td>

            <td>
              {% if is_open %}
                <span class="muted">Hidden until kickoff</span>
              {% else %}
                {% set preds = all_preds.get(f.id, []) %}
                {% if preds %}
                  <div class="all-picks">
                    {% for uname, sel in preds %}
                      <span class="pill" title="{{ uname }}">{{ sel }}</span>
                    {% endfor %}
                  </div>
                {% else %}
                  <span class="muted">No picks yet</span>
                {% endif %}
              {% endif %}
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <form id="bulkForm" method="post" action="{{ url_for('save_all_predictions') }}" class="bulk-save">
    <button class="btn btn-primary">Save all selected picks</button>
  </form>
  {% else %}
    <div class="empty-state">
      <h2>No upcoming fixtures yet</h2>
      <p>Check back soon. We’ll pull new fixtures automatically.</p>
    </div>
  {% endif %}
</section>

{% endblock %}
