<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Serie A Predictor</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    .live { background: #fff4e5; }
    .status-badge { font-size: 12px; padding: 2px 6px; border-radius: 4px; }
    .status-live { background: #ffecb3; border: 1px solid #ffb300; }
    .status-finished { background: #e0f2f1; border: 1px solid #26a69a; }
    .status-scheduled { background: #e3f2fd; border: 1px solid #64b5f6; }
    .score { font-weight: 600; }
    .kickoff small { color: #666; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 8px 10px; border-bottom: 1px solid #eee; vertical-align: top; }
  </style>
</head>
<body>
  <header>
    <h1>Upcoming & Live Fixtures</h1>
    <nav>
      <a href="{{ url_for('leaderboard') }}">Leaderboard</a>
      <a href="{{ url_for('logout') }}">Logout</a>
    </nav>
  </header>

  {% if fixtures %}
  <form method="post" action="{{ url_for('save_all_predictions') }}">
    <table>
      <thead>
        <tr>
          <th>Kickoff (your time)</th>
          <th>Fixture</th>
          <th>Status / Score</th>
          <th>Your Pick</th>
          {% if users_cols %}
            <th>All Picks (revealed at kickoff)</th>
          {% endif %}
        </tr>
      </thead>
      <tbody>
        {% for f in fixtures %}
        <tr class="{% if live_flags.get(f.id) %}live{% endif %}">
          <td class="kickoff" data-utc="{{ f.match_date|utc_iso }}">
            <div class="local"></div>
            <small class="utc">(<span class="utc-text"></span> UTC)</small>
          </td>
          <td>
            <div><strong>{{ f.home_team }}</strong> vs <strong>{{ f.away_team }}</strong></div>
            <div>Matchday {{ f.matchday or "—" }}</div>
          </td>
          <td>
            {% if f.status in ("IN_PLAY","PAUSED") %}
              <span class="status-badge status-live">{{ f.status.replace('_', ' ') }}</span>
              <div class="score">{{ f.home_score if f.home_score is not none else "-" }} &ndash; {{ f.away_score if f.away_score is not none else "-" }}</div>
            {% elif f.status == "FINISHED" %}
              <span class="status-badge status-finished">Finished</span>
              <div class="score">{{ f.home_score if f.home_score is not none else "-" }} &ndash; {{ f.away_score if f.away_score is not none else "-" }}</div>
            {% else %}
              <span class="status-badge status-scheduled">{{ f.status }}</span>
            {% endif %}
          </td>
          <td>
            {% set open = f.is_open_for_prediction() %}
            {% if open %}
              {% set existing = user_predictions.get(f.id) %}
              <select name="fixture_{{ f.id }}">
                <option value="" {% if not existing %}selected{% endif %} disabled>Pick…</option>
                <option value="1" {% if existing and existing.selection == "1" %}selected{% endif %}>1 (Home)</option>
                <option value="X" {% if existing and existing.selection == "X" %}selected{% endif %}>X (Draw)</option>
                <option value="2" {% if existing and existing.selection == "2" %}selected{% endif %}>2 (Away)</option>
              </select>
            {% else %}
              {% set existing = user_predictions.get(f.id) %}
              {% if existing %}<strong>{{ existing.selection }}</strong>{% else %}<em>—</em>{% endif %}
            {% endif %}
          </td>

          {% if users_cols %}
          <td>
            {% if show_preds_flags.get(f.id) %}
              <ul style="margin:0; padding-left: 16px;">
                {% for uid, uname in users_cols %}
                  <li>
                    <strong>{{ uname }}</strong>:
                    {{ pred_matrix.get((f.id, uid)) or "—" }}
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <em>Hidden until kickoff</em>
            {% endif %}
          </td>
          {% endif %}
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <p style="margin-top: 12px;">
      <button type="submit">Save all open picks</button>
    </p>
  </form>
  {% else %}
    <p>No fixtures to show yet.</p>
  {% endif %}

  <script>
    // Convert UTC ISO string in data-utc -> human local time
    function fmt(dt) {
      // e.g. "Sat, 23 Aug 2025 20:45"
      return dt.toLocaleString(undefined, {
        weekday: 'short',
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: false
      });
    }
    document.querySelectorAll('.kickoff').forEach(cell => {
      const iso = cell.getAttribute('data-utc');
      if (!iso) return;
      const d = new Date(iso); // parsed as UTC by ISO "Z"
      const localDiv = cell.querySelector('.local');
      const utcText = cell.querySelector('.utc-text');
      if (localDiv) localDiv.textContent = fmt(d);
      if (utcText) utcText.textContent = d.toISOString().slice(11, 16); // HH:MM UTC
    });
  </script>
</body>
</html>
