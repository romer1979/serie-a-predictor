{% extends "layout.html" %}
{% block title %}Fixtures · Serie A Predictor{% endblock %}

{% block head %}
<style>
  /* ============ Mobile-first: compact row ============ */
  .fx-wrap { display: grid; gap: .5rem; }
  .fx-row {
    display: grid;
    grid-template-columns: 1fr auto auto; /* teams | pick | status */
    align-items: center;
    padding: .5rem .75rem;
    border-bottom: 1px solid rgba(255,255,255,.08);
  }
  .fx-teams {
    font-weight: 600;
    line-height: 1.2;
  }
  .fx-meta {
    font-size: .85rem;
    opacity: .85;
  }
  .fx-pick {
    display: flex; gap: .4rem; justify-content: center; align-items: center;
  }
  .fx-pick .radio { display: inline-flex; gap: .25rem; align-items:center; }
  .fx-pick input[type="radio"] { transform: scale(1.1); }
  .fx-status { text-align: right; min-width: 54px; }
  .pill {
    display: inline-block; padding: .15rem .5rem; border-radius: 999px;
    font-size: .75rem; border: 1px solid rgba(255,255,255,.2);
  }
  .pill.live { background: rgba(220, 53, 69,.2); border-color: rgba(220,53,69,.35); }
  .pill.finished { background: rgba(25,135,84,.18); border-color: rgba(25,135,84,.35); }
  .pill.scheduled { background: rgba(108,117,125,.18); border-color: rgba(108,117,125,.35); }

  /* Kickoff small line */
  .fx-ko { font-size: .85rem; opacity: .85; }

  /* Drawer of other users’ picks (per match) */
  .fx-drawer {
    display: none;
    padding: .4rem .5rem .6rem;
    border-left: 3px solid rgba(255,255,255,.12);
    margin: .35rem 0 .5rem .25rem;
    background: rgba(255,255,255,.03);
    border-radius: 8px;
  }
  .fx-drawer.open { display: block; }
  .picks-strip {
    display: flex; flex-wrap: wrap; gap: .35rem .5rem;
  }
  .pick-pill {
    white-space: nowrap; border-radius: 9999px; padding: .2rem .45rem;
    font-size: .8rem; background: var(--bs-gray-800);
    color: var(--bs-body-color); border: 1px solid var(--bs-gray-700);
  }
  .pick-correct {
    background: rgba(25,135,84,.18);
    border-color: rgba(25,135,84,.35);
    font-weight: 600;
  }
  .fx-actions { display:flex; align-items:center; gap:.5rem; justify-content:flex-end; }
  .btn-tiny { font-size: .8rem; padding: .25rem .5rem; border-radius: 8px; border: 1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.06); color: inherit; }
  .btn-tiny:hover { filter: brightness(1.05); }

  /* Save All button pinned at bottom on phones */
  .sticky-save {
    position: sticky; bottom: 0; z-index: 5;
    padding: .5rem .75rem; background: var(--bs-body-bg);
    border-top: 1px solid rgba(255,255,255,.08);
    display: flex; justify-content: space-between; align-items: center; gap: .5rem;
  }
  .btn-primary { background: #2563eb; border-color: #2563eb; color: #fff; border-radius: 10px; padding: .55rem .8rem; }
  .btn-primary:hover { filter: brightness(1.05); }

  /* ============ Desktop enhancements ============ */
  @media (min-width: 900px) {
    .fx-row {
      grid-template-columns: 220px 1fr 180px 160px 90px; 
      /* kickoff | teams | your pick | actions | status */
      gap: .5rem 1rem;
    }
    .fx-ko { grid-column: 1 / 2; }
    .fx-teams { grid-column: 2 / 3; }
    .fx-pick { grid-column: 3 / 4; }
    .fx-actions { grid-column: 4 / 5; }
    .fx-status { grid-column: 5 / 6; }
  }

  /* Keep radio labels tappable */
  .radio span { font-size: .9rem; }
</style>
{% endblock %}

{% block content %}
  <div class="section-title" style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;">
    <h1 style="margin:0;font-size:20px;">
      {{ season or 'Season' }} — Matchday {{ matchday or '—' }}
    </h1>
    <div class="fx-meta" id="tz-hint"></div>
  </div>

  {% if fixtures|length == 0 %}
    <div class="card">No fixtures available. Check back soon!</div>
  {% else %}

  <form method="post" action="{{ url_for('save_all_predictions') }}">
    <div class="fx-wrap">
      {% for f in fixtures %}
        {% set my = user_predictions.get(f.id) %}
        {% set locked = not f.is_open_for_prediction() %}
        {% set reveal = show_preds_flags.get(f.id) %}
        {% set outcome = f.outcome_code() %}
        <div class="fx-row">
          <!-- kickoff (mobile: inline under teams; desktop: own column via media query) -->
          <div class="fx-ko">
            <time class="kickoff-local"
                  data-utc="{{ (f.match_date if f.match_date.tzinfo else f.match_date.replace(tzinfo=none))|utc_iso }}">
              {{ f.match_date }}
            </time>
          </div>

          <!-- teams -->
          <div class="fx-teams">
            {{ f.home_team }} <span class="muted">vs</span> {{ f.away_team }}
            <div class="fx-meta">MD {{ f.matchday or '—' }}</div>
          </div>

          <!-- your 1/X/2 radios (no per-row submit; uses Save All) -->
          <div class="fx-pick">
            {% for opt,label in [('1','1'),('X','X'),('2','2')] %}
              <label class="radio">
                <input type="radio" name="fixture_{{ f.id }}" value="{{ opt }}"
                       {% if my and my.selection == opt %}checked{% endif %}
                       {% if locked %}disabled{% endif %}>
                <span>{{ label }}</span>
              </label>
            {% endfor %}
          </div>

          <!-- actions: show other picks (drawer) + result -->
          <div class="fx-actions">
            <button class="btn-tiny" type="button"
                    data-drawer="#drawer-{{ f.id }}">Picks</button>

            {% if f.home_score is not none and f.away_score is not none %}
              <span class="fx-meta"><strong>{{ f.home_score }}–{{ f.away_score }}</strong></span>
            {% else %}
              <span class="fx-meta muted">—</span>
            {% endif %}
          </div>

          <!-- status -->
          <div class="fx-status">
            {% if f.status in ['IN_PLAY','PAUSED'] %}
              <span class="pill live">LIVE</span>
            {% elif f.status == 'FINISHED' %}
              <span class="pill finished">FT</span>
            {% else %}
              <span class="pill scheduled">TIMED</span>
            {% endif %}
          </div>

          <!-- drawer with other users’ picks; opens inline (no page scroll) -->
          <div id="drawer-{{ f.id }}" class="fx-drawer">
            {% if users_cols|length == 0 %}
              <div class="fx-meta muted">No other players yet.</div>
            {% else %}
              <div class="picks-strip">
                {% for uid, uname in users_cols %}
                  {% set pick = pred_matrix.get((f.id, uid)) %}
                  {% if reveal %}
                    {% set is_correct = (outcome is not none and pick == outcome) %}
                    <span class="pick-pill {% if is_correct %}pick-correct{% endif %}">
                      <strong>{{ uname }}</strong>:
                      {{ pick or '—' }}
                    </span>
                  {% else %}
                    <span class="pick-pill"><strong>{{ uname }}</strong>: —</span>
                  {% endif %}
                {% endfor %}
              </div>
            {% endif %}
          </div>
        </div>
      {% endfor %}
    </div>

    <!-- sticky save (always visible on mobile, unobtrusive on desktop) -->
    <div class="sticky-save">
      <div class="fx-meta">Your changes are not saved yet.</div>
      <button class="btn btn-primary" type="submit">💾 Save All Predictions</button>
    </div>
  </form>

  {% endif %}
{% endblock %}

{% block scripts %}
<script>
  // Local kickoff formatting + timezone hint
  function fmt(dt){
    const d = new Date(dt);
    const opts = {weekday:'short', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'};
    return d.toLocaleString(undefined, opts);
  }
  document.querySelectorAll('.kickoff-local').forEach(el=>{
    const iso = el.getAttribute('data-utc'); if (!iso) return;
    el.textContent = fmt(iso);
  });
  (function(){
    try {
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || '';
      const el = document.getElementById('tz-hint');
      if (el && tz) el.textContent = 'Times shown in ' + tz.replace('_',' ');
    } catch(e){}
  })();

  // Open/close drawers for “Picks” (no scroll; inline)
  document.querySelectorAll('[data-drawer]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const sel = btn.getAttribute('data-drawer');
      const panel = document.querySelector(sel);
      if (!panel) return;
      panel.classList.toggle('open');
      btn.textContent = panel.classList.contains('open') ? 'Hide' : 'Picks';
    });
  });
</script>
{% endblock %}
