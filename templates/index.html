<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Serie A Fixtures</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 0; padding: 24px; }
    h1 { margin: 0 0 8px; }
    .note { color: #555; margin: 0 0 24px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid #eee; text-align: left; white-space: nowrap; }
    th.status, td.status { text-align: center; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; }
    .b-upcoming { background: #eef6ff; color: #155fa0; }
    .b-live     { background: #fff4d6; color: #79520a; }
    .b-ft       { background: #eaf7ea; color: #246b2f; }
    .muted { color: #777; }
    .nowrap { white-space: nowrap; }
  </style>
</head>
<body>
  <h1>Serie A Fixtures</h1>
  <p class="note">Kickoff is shown in <strong>your local time</strong>. Source times are in Italy local time.</p>

  <table id="fx-table">
    <thead>
      <tr>
        <th>Match</th>
        <th>Kickoff (local)</th>
        <th class="status">Status</th>
        <th class="nowrap">Score</th>
      </tr>
    </thead>
    <tbody>
      {% for f in fixtures %}
      <tr data-id="{{ f.id }}">
        <td>{{ f.home }} vs {{ f.away }}</td>

        <!-- Emit machine-readable UTC; JS localizes text -->
        <td class="kickoff" data-utc="{{ f.kickoff_utc|utc_iso }}">
          <span class="muted">
            {{ f.kickoff_utc.split('T')[0] }} {{ f.kickoff_utc[11:16] }} UTC
          </span>
        </td>

        <td class="status">
          {% if f.status == 'UPCOMING' %}
            <span class="badge b-upcoming">UPCOMING</span>
          {% elif f.status == 'LIVE' %}
            <span class="badge b-live">LIVE</span>
          {% elif f.status == 'FT' %}
            <span class="badge b-ft">FT</span>
          {% else %}
            <span class="badge">{{ f.status }}</span>
          {% endif %}
        </td>

        <td class="nowrap score">
          {% if f.home_score is not none and f.away_score is not none %}
            {{ f.home_score }}–{{ f.away_score }}
          {% else %}
            <span class="muted">—</span>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <script>
    // Localize kickoff cells for each viewer
    (function () {
      var opts = {
        weekday: 'short',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      };
      function localizeTimes() {
        var cells = document.querySelectorAll('.kickoff[data-utc]');
        cells.forEach(function(td) {
          var iso = td.getAttribute('data-utc');
          if (!iso) return;
          var d = new Date(iso);
          if (isNaN(d.getTime())) return;
          td.textContent = new Intl.DateTimeFormat(undefined, opts).format(d);
          td.title = iso + ' (UTC instant)';
        });
      }
      localizeTimes();

      // Optional: auto-refresh status/score every 30s
      async function refreshFixtures() {
        try {
          const res = await fetch('/api/fixtures', { cache: 'no-store' });
          if (!res.ok) return;
          const payload = await res.json();
          const byId = {};
          payload.fixtures.forEach(f => { byId[String(f.id)] = f; });

          document.querySelectorAll('#fx-table tbody tr[data-id]').forEach(tr => {
            const id = tr.getAttribute('data-id');
            const f = byId[id];
            if (!f) return;

            // kickoff
            const kd = tr.querySelector('.kickoff');
            if (kd && kd.getAttribute('data-utc') !== f.kickoff_utc) {
              kd.setAttribute('data-utc', f.kickoff_utc);
            }

            // status
            const st = tr.querySelector('.status .badge');
            if (st && st.textContent !== f.status) {
              st.textContent = f.status;
              st.className = 'badge ' + (
                f.status === 'UPCOMING' ? 'b-upcoming' :
                f.status === 'LIVE'     ? 'b-live' :
                f.status === 'FT'       ? 'b-ft' : ''
              );
            }

            // score
            const sc = tr.querySelector('.score');
            if (sc) {
              if (f.home_score != null && f.away_score != null) {
                const newText = `${f.home_score}–${f.away_score}`;
                if (sc.textContent.trim() !== newText) sc.textContent = newText;
              } else {
                sc.innerHTML = '<span class="muted">—</span>';
              }
            }
          });

          localizeTimes();
        } catch (e) {
          // ignore network hiccups
        }
      }

      setInterval(refreshFixtures, 30000);
    })();
  </script>
</body>
</html>
