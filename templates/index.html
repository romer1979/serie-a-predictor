{% extends "layout.html" %}
{% block title %}Fixtures · Serie A Predictor{% endblock %}

{% block content %}
  <div class="section-title">
    <h1 style="margin:0;font-size:20px">Upcoming & Live Fixtures</h1>
    <form action="{{ url_for('save_all_predictions') }}" method="post">
      <button class="btn primary tiny" type="submit">Save all my picks</button>
    </form>
  </div>

  {% if fixtures|length == 0 %}
    <div class="card">No fixtures in the next 7 days. Check back soon!</div>
  {% endif %}

  <div class="cards">
    {% for f in fixtures %}
      {% set is_live = f.status in ('IN_PLAY','PAUSED') %}
      {% set is_finished = f.status == 'FINISHED' %}
      {% set is_locked = not f.is_open_for_prediction() %}
      {% set my = user_predictions.get(f.id) %}
      <article class="card" aria-labelledby="fx-{{ f.id }}">
        <div class="row">
          <div class="teams">
            <span id="fx-{{ f.id }}">
              <span>{{ f.home_team }}</span>
              <span class="muted tiny">vs</span>
              <span>{{ f.away_team }}</span>
            </span>
            <span class="tiny muted">
              <time class="kick" data-utc="{{ (f.match_date if f.match_date.tzinfo else f.match_date.replace(tzinfo=namespace().tz if false else None))|utc_iso }}">{{ f.match_date }}</time>
            </span>
          </div>

          <div class="row" style="gap:10px">
            {% if is_live %}
              <span class="pill live">LIVE</span>
            {% elif is_finished %}
              <span class="pill finished">FT</span>
            {% else %}
              <span class="pill scheduled">{{ f.status }}</span>
            {% endif %}
            <div class="score">
              {% if f.home_score is not none and f.away_score is not none %}
                {{ f.home_score }}&nbsp;–&nbsp;{{ f.away_score }}
              {% else %}
                <span class="muted">–</span>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Your pick -->
        <div class="row" style="margin-top:12px">
          <form class="choice" action="{{ url_for('predict', fixture_id=f.id) }}" method="post">
            {% for opt,label in [('1','Home'),('X','Draw'),('2','Away')] %}
              <label class="radio">
                <input type="radio" name="selection" value="{{ opt }}"
                  {% if my and my.selection == opt %}checked{% endif %}
                  {% if is_locked %}disabled{% endif %} />
                <span class="tiny">{{ label }}</span>
              </label>
            {% endfor %}
            <button class="btn tiny" type="submit" {% if is_locked %}disabled{% endif %}>
              {% if my %}Update{% else %}Pick{% endif %}
            </button>
          </form>

          {% if is_locked and not is_finished %}
            <span class="tiny muted">Locked at kickoff</span>
          {% endif %}
        </div>

        <!-- Group picks (revealed at/after kickoff or if live/paused/finished) -->
        {% if show_preds_flags.get(f.id) %}
          <div class="stack" style="margin-top:12px">
            <div class="tiny muted">Predictions</div>
            <div class="preds">
              {% for (uid, uname) in users_cols %}
                {% set pick = pred_matrix.get((f.id, uid)) %}
                {% if pick %}
                  <span class="chip">{{ uname }}: {{ pick }}</span>
                {% endif %}
              {% endfor %}
              {% if users_cols|length == 0 %}
                <span class="muted tiny">No predictions yet.</span>
              {% endif %}
            </div>
          </div>
        {% endif %}
      </article>
    {% endfor %}
  </div>
{% endblock %}
