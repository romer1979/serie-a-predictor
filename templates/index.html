{% extends 'layout.html' %}
{% block content %}
  <h1 class="mb-4">Upcoming Fixtures</h1>
  {% if not fixtures %}
    <p>No fixtures scheduled in the next 7 days.</p>
  {% else %}
    <div class="table-responsive">
      <table class="table table-striped align-middle">
        <thead>
          <tr>
            <th>Date & Time</th>
            <th>Home</th>
            <th></th>
            <th>Away</th>
            <th>Your Pick</th>
            <th>Result / Status</th>
            <th>Predictions (visible after kickoff)</th>
          </tr>
        </thead>
        <tbody>
          {% for f in fixtures %}
            <tr>
              <td>{{ f.match_date.strftime('%Y-%m-%d %H:%M') }}</td>
              <td class="fw-semibold">{{ f.home_team }}</td>
              <td class="text-muted">vs</td>
              <td class="fw-semibold">{{ f.away_team }}</td>

              {# --- Your Pick cell --- #}
              <td>
                {% set myp = user_predictions.get(f.id) %}
                {% if f.is_open_for_prediction() %}
                  <form method="post" action="{{ url_for('predict', fixture_id=f.id) }}" class="d-flex gap-2">
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="selection" id="p1-{{ f.id }}" value="1" {% if myp and myp.selection == '1' %}checked{% endif %}>
                      <label class="form-check-label" for="p1-{{ f.id }}">1</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="selection" id="px-{{ f.id }}" value="X" {% if myp and myp.selection == 'X' %}checked{% endif %}>
                      <label class="form-check-label" for="px-{{ f.id }}">X</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="radio" name="selection" id="p2-{{ f.id }}" value="2" {% if myp and myp.selection == '2' %}checked{% endif %}>
                      <label class="form-check-label" for="p2-{{ f.id }}">2</label>
                    </div>
                    <button class="btn btn-sm btn-primary" type="submit">Save</button>
                  </form>
                {% else %}
                  {% if myp %}
                    <span class="badge bg-secondary">Locked: {{ myp.selection }}</span>
                  {% else %}
                    <span class="badge bg-secondary">Locked</span>
                  {% endif %}
                {% endif %}
              </td>

              {# --- Result / Status cell --- #}
              <td>
                {% if f.status in ['IN_PLAY', 'PAUSED'] %}
                  <span class="badge bg-warning text-dark">LIVE</span>
                  {% if f.home_score is not none and f.away_score is not none %}
                    <div>{{ f.home_score }} — {{ f.away_score }}</div>
                  {% endif %}
                {% elif f.status == 'FINISHED' %}
                  <span class="badge bg-success">FT</span>
                  <div>{{ f.home_score }} — {{ f.away_score }}</div>
                {% else %}
                  <span class="text-muted">{{ f.status }}</span>
                {% endif %}
              </td>

              {# --- All players' predictions (only after kickoff) --- #}
              <td style="max-width: 320px;">
                {% if f.is_open_for_prediction() %}
                  <span class="text-muted">Hidden until kickoff</span>
                {% else %}
                  {% set plist = all_preds.get(f.id, []) %}
                  {% if not plist %}
                    <span class="text-muted">No predictions</span>
                  {% else %}
                    <ul class="mb-0 ps-3">
                      {% for uname, sel in plist %}
                        <li><strong>{{ uname }}</strong>: {{ sel }}</li>
                      {% endfor %}
                    </ul>
                  {% endif %}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% endif %}
{% endblock %}
