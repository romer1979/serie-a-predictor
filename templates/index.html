{% extends 'layout.html' %}
{% block title %}Fixtures & Predictions{% endblock %}

{% block content %}
<h1>Upcoming & Live Fixtures</h1>

<p class="hint">
  Kickoff times are shown in your local time. Live games stay visible and update points provisionally.
</p>

<form method="post" action="{{ url_for('save_all_predictions') }}">
  <table class="fixtures">
    <thead>
      <tr>
        <th>When</th>
        <th>Match</th>
        <th>Status</th>
        <th>Score</th>
        <th>Your Pick</th>
        {% if users_cols %}
          <th class="pred-matrix">All Picks{% if users_cols %} ({{ users_cols|length }}){% endif %}</th>
        {% endif %}
      </tr>
    </thead>
    <tbody>
      {% for f in fixtures %}
      <tr class="
        {% if f.status in ('IN_PLAY','PAUSED') %}live{% elif f.status == 'FINISHED' %}finished{% else %}upcoming{% endif %}
      ">
        <td>
          <!-- Store UTC in attribute; show local via JS -->
          <time class="kickoff" data-utc="{{ f.match_date|utc_iso }}">
            {{ f.match_date|utc_iso }}
          </time>
        </td>

        <td class="match">{{ f.home_team }} vs {{ f.away_team }}</td>

        <td class="status">
          {% if f.status in ('IN_PLAY','PAUSED') %}
            <span class="badge live">LIVE</span>
          {% elif f.status == 'FINISHED' %}
            <span class="badge finished">FT</span>
          {% elif f.status in ('SCHEDULED','TIMED') %}
            <span class="badge scheduled">Upcoming</span>
          {% else %}
            <span class="badge">{{ f.status }}</span>
          {% endif %}
        </td>

        <td class="score">
          {% if f.home_score is not none and f.away_score is not none %}
            <strong>{{ f.home_score }}&nbsp;–&nbsp;{{ f.away_score }}</strong>
            {% if provisional_flags.get(f.id) %}
              <small class="provisional">(provisional)</small>
            {% endif %}
          {% else %}
            <span class="muted">–</span>
          {% endif %}
        </td>

        <td class="your-pick">
          {% if f.is_open_for_prediction() %}
            {% set current = (user_predictions.get(f.id).selection if user_predictions.get(f.id) else None) %}
            <label><input type="radio" name="fixture_{{ f.id }}" value="1" {% if current == '1' %}checked{% endif %}> 1</label>
            <label><input type="radio" name="fixture_{{ f.id }}" value="X" {% if current == 'X' %}checked{% endif %}> X</label>
            <label><input type="radio" name="fixture_{{ f.id }}" value="2" {% if current == '2' %}checked{% endif %}> 2</label>
          {% else %}
            {% set p = user_predictions.get(f.id) %}
            {% if p %}
              <strong>{{ p.selection }}</strong>
              {% if p.points_awarded is not none %}
                <small class="{{ 'pts-win' if p.points_awarded==1 else 'pts-lose' }}">
                  ({{ p.points_awarded }} pt{{ '' if p.points_awarded==1 else 's' }})
                  {% if provisional_flags.get(f.id) %}<em> provisional</em>{% endif %}
                </small>
              {% endif %}
            {% else %}
              <span class="muted">—</span>
            {% endif %}
          {% endif %}
        </td>

        {% if users_cols %}
          <td class="pred-matrix">
            {% if show_preds_flags.get(f.id) %}
              <div class="grid">
                {% for uid, uname in users_cols %}
                  <div class="cell" title="{{ uname }}">
                    {{ pred_matrix.get((f.id, uid)) or '·' }}
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <span class="muted">Hidden until kickoff</span>
            {% endif %}
          </td>
        {% endif %}
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="actions">
    <button type="submit">Save all picks</button>
  </div>
</form>

<style>
  .fixtures { width: 100%; border-collapse: collapse; }
  .fixtures th, .fixtures td { border-bottom: 1px solid #eee; padding: 8px; vertical-align: middle; }
  .badge { padding: 2px 6px; border-radius: 6px; font-size: 12px; }
  .badge.live { background: #ffe6e6; color: #c40000; font-weight: 700; }
  .badge.finished { background: #e6ffe6; color: #006600; }
  .badge.scheduled { background: #e6f0ff; color: #0033aa; }
  .muted { color: #888; }
  .provisional { color: #c40000; }
  .pred-matrix .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(20px, 1fr)); gap: 2px; }
  .pred-matrix .cell { text-align: center; font-family: monospace; border: 1px solid #f0f0f0; border-radius: 4px; padding: 2px 0; }
  tr.live { background: #fffaf6; }
  tr.finished { background: #fafafa; }
  .actions { margin-top: 12px; }
  .pts-win { color: #0a7a0a; }
  .pts-lose { color: #a00; }
</style>

<script>
  // Convert UTC times to the viewer's local time and refresh periodically
  function renderLocalTimes() {
    document.querySelectorAll('time.kickoff').forEach(el => {
      const isoUtc = el.getAttribute('data-utc');
      if (!isoUtc) return;
      const d = new Date(isoUtc);
      if (isNaN(d.getTime())) return;
      // Show like "Sat, Aug 23 • 3:00 PM"
      el.textContent = d.toLocaleString(undefined, {
        weekday: 'short', month: 'short', day: 'numeric',
        hour: 'numeric', minute: '2-digit'
      });
      el.setAttribute('title', d.toString());
    });
  }
  renderLocalTimes();
  // In case the page stays open across DST/time changes, re-render occasionally
  setInterval(renderLocalTimes, 60_000);
</script>
{% endblock %}
